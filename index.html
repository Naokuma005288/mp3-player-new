<!DOCTYPE html>
<html lang="ja" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç™„Ç∑„É£„É¨„Å™MP3„Éó„É¨„Ç§„É§„Éº v3.0</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>

    <style>
        :root {
            font-family: 'Inter', sans-serif;

            --bg-gradient-from: #4f46e5; 
            --bg-gradient-via: #a855f7; 
            --bg-gradient-to: #ec4899; 
            
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-tertiary: rgba(255, 255, 255, 0.5);
            
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: rgba(31, 38, 135, 0.5);
            
            --control-primary: #ffffff;
            --control-secondary: rgba(255, 255, 255, 0.7);
            --control-hover: #ffffff;
            
            --play-btn-bg: #ffffff;
            --play-btn-icon: #4f46e5;
            
            --range-track-bg: rgba(255, 255, 255, 0.25);
            
            --thumb-color: #EC4899;
            --thumb-shadow: #EC4899;
            --thumb-hover-color: #F472B6;

            --btn-active-color: #EC4899;
            
            --playlist-bg: rgba(0, 0, 0, 0.8);
            --playlist-item-hover: rgba(255, 255, 255, 0.2);
            --playlist-item-active: rgba(236, 72, 153, 0.5);
            --playlist-ring: #EC4899;
            --playlist-search-bg: rgba(255, 255, 255, 0.1);

            --viz-grad-1: #6366F1;
            --viz-grad-2: #EC4899;
            --viz-grad-3: #FFFFFF;
            
            --toast-bg: #1f2937;
            --toast-text: #ffffff;
        }

        .light-mode {
            --bg-gradient-from: #e0f2fe; 
            --bg-gradient-via: #fbcfe8; 
            --bg-gradient-to: #fef08a; 

            --text-primary: #1f2937; 
            --text-secondary: #4b5563; 
            --text-tertiary: #6b7280; 
            
            --glass-bg: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(255, 255, 255, 0.8);
            --glass-shadow: rgba(100, 116, 139, 0.3); 
            
            --control-primary: #1f2937;
            --control-secondary: #4b5563;
            --control-hover: #000000;

            --play-btn-bg: #4f46e5; 
            --play-btn-icon: #ffffff;
            
            --range-track-bg: rgba(0, 0, 0, 0.1);
            
            --thumb-color: #db2777; 
            --thumb-shadow: #db2777;
            --thumb-hover-color: #ec4899;

            --btn-active-color: #db2777;
            
            --playlist-bg: rgba(255, 255, 255, 0.85);
            --playlist-item-hover: rgba(0, 0, 0, 0.1);
            --playlist-item-active: rgba(219, 39, 119, 0.3); 
            --playlist-ring: #db2777;
            --playlist-search-bg: rgba(0, 0, 0, 0.05);

            --viz-grad-1: #4f46e5;
            --viz-grad-2: #db2777;
            --viz-grad-3: #1f2937;
            
            --toast-bg: #ffffff;
            --toast-text: #1f2937;
        }

        .glass-container {
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            background-color: var(--glass-bg); 
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 var(--glass-shadow); 
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; 
        }

        body {
            background-image: linear-gradient(to bottom right, var(--bg-gradient-from), var(--bg-gradient-via), var(--bg-gradient-to));
            transition: background 0.5s ease-in-out;
            color: var(--text-primary);
        }

        .glass-container.minimal {
            max-width: 250px; 
            padding: 4px; 
            height: 250px;
        }

        .file-select-hidden { opacity: 0 !important; pointer-events: none !important; }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px; width: 16px; border-radius: 50%;
            background: var(--thumb-color); cursor: pointer;
            box-shadow: 0 0 8px var(--thumb-shadow);
            margin-top: -6px;
            transition: transform 0.2s, background-color 0.2s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.25); background-color: var(--thumb-hover-color); }

        input[type=range]::-moz-range-thumb {
            height: 16px; width: 16px; border-radius: 50%;
            background: var(--thumb-color); cursor: pointer;
            box-shadow: 0 0 8px var(--thumb-shadow);
            transition: transform 0.2s, background-color 0.2s;
        }
        input[type=range]::-moz-range-thumb:hover { transform: scale(1.25); background-color: var(--thumb-hover-color); }

        input[type=range]::-webkit-slider-runnable-track, input[type=range]::-moz-range-track {
            height: 4px; background-color: var(--range-track-bg); border-radius: 2px;
        }

        #visualizer-canvas {
            position: absolute; bottom: 0; left: 0;
            width: 100%; height: 40%;
            opacity: 0.85;
            mask-image: linear-gradient(to top, rgba(0,0,0,1) 70%, rgba(0,0,0,0) 100%);
            -webkit-mask-image: linear-gradient(to top, rgba(0,0,0,1) 70%, rgba(0,0,0,0) 100%);
        }

        .btn-active { color: var(--btn-active-color) !important; }

        .digital-time { font-variant-numeric: tabular-nums; transition: all 0.2s ease-out; display: inline-block; }

        .hide-on-minimal {
            opacity: 1; transform: translateY(0);
            transition: opacity 0.5s, transform 0.5s, margin 0.5s, height 0.5s;
        }
        .minimal .hide-on-minimal {
            opacity: 0 !important; transform: translateY(20px) !important;
            pointer-events: none; height: 0; margin: 0 !important; padding: 0 !important;
        }

        #playlist-panel {
            position: fixed; top: 0; right: 0;
            width: 100%; max-width: 380px; height: 100%;
            transform: translateX(100%); z-index: 50;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            background-color: var(--playlist-bg);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.5s;
            padding: 1rem; color: var(--text-primary);
        }
        #playlist-panel.open { transform: translateX(0); }

        .playlist-item { background-color: transparent; transition: background-color 0.2s; }
        .playlist-item:hover { background-color: var(--playlist-item-hover); }
        .playlist-item.active {
            background-color: var(--playlist-item-active);
            box-shadow: 0 0 0 2px var(--playlist-ring);
        }
        .playlist-item.dragging { opacity: 0.5; }

        #playlist-search {
            background-color: var(--playlist-search-bg);
            color: var(--text-primary);
            border-color: var(--glass-border);
        }
        #playlist-search::placeholder { color: var(--text-tertiary); }

        .control-btn { color: var(--control-secondary); }
        .control-btn:hover { color: var(--control-hover); }
        .control-btn:disabled { color: var(--text-tertiary); opacity: 0.5; }

        #play-pause-btn { background-color: var(--play-btn-bg); color: var(--play-btn-icon); }

        #song-artist { color: var(--text-secondary); }
        #current-time-display, #duration-display, .playlist-duration { color: var(--text-secondary); }
        #playlist-ul li.placeholder { color: var(--text-tertiary); }

        #toast {
            position: fixed; bottom: -100px; left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1.5rem; border-radius: 0.5rem;
            background-color: var(--toast-bg); color: var(--toast-text);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            z-index: 100; transition: all 0.5s cubic-bezier(0.4,0,0.2,1);
            opacity: 0; pointer-events: none;
        }
        #toast.show { bottom: 2rem; opacity: 1; }

        .like-btn { font-size: 18px; line-height: 1; }
        .like-btn.active { color: var(--btn-active-color); }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4 antialiased">
    
    <div id="player-container" class="glass-container w-full max-w-sm rounded-2xl p-6 space-y-6 transition-all duration-500">
        
        <button id="playlist-toggle-btn" class="control-btn absolute top-4 right-4 transition-all transform hover:scale-110 active:scale-95 disabled:cursor-not-allowed z-30" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h7" />
            </svg>
        </button>

        <audio id="audio-player" style="display: none;"></audio>

        <div id="drop-zone" class="relative w-full aspect-square rounded-xl overflow-hidden bg-black/10 flex items-center justify-center shadow-2xl transition-all duration-500 ease-in-out cursor-pointer" oncontextmenu="return false;">
            
            <img id="album-art" src="https://placehold.co/512x512/312e81/ffffff?text=MP3" 
                 onerror="this.onerror=null; this.src='https://placehold.co/512x512/312e81/ffffff?text=MP3';"
                 class="w-full h-full object-cover transition-opacity duration-500 opacity-20" alt="Album Art">

            <canvas id="visualizer-canvas"></canvas>

            <div id="file-select-ui" class="z-20 absolute transition-opacity duration-500 flex flex-col items-center justify-center p-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mx-auto text-white/50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h4l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                </svg>
                <p id="drop-message" class="mt-3 text-sm text-center transition-colors duration-300" style="color: rgba(255, 255, 255, 0.8);">
                    MP3„Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó
                </p>
                <label for="file-input" class="mt-2 inline-block bg-white/30 hover:bg-white/40 px-4 py-2 rounded-lg text-sm font-medium cursor-pointer transition-all transform hover:scale-105">
                    „Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû
                </label>
                <input type="file" id="file-input" accept=".mp3" class="hidden" multiple>
            </div>
            
            <div id="minimal-play-btn-overlay" class="absolute inset-0 flex items-center justify-center opacity-0 transition-opacity duration-500 z-20 pointer-events-none">
                <svg id="minimal-play-icon" xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white/90 hidden" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                </svg>
                <svg id="minimal-pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white/90 hidden" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1H8zm5 0a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1h-1z" clip-rule="evenodd" />
                </svg>
            </div>
        </div>
        
        <!-- Êõ≤ÊÉÖÂ†± -->
        <div class="text-center hide-on-minimal space-y-1">
            <h2 id="song-title" class="text-xl font-bold truncate">ÂÜçÁîü„Åô„ÇãÊõ≤„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</h2>
            <p id="song-artist" class="text-sm mt-1 truncate">„Éï„Ç°„Ç§„É´„Çí„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>

            <!-- ‚úÖ „ÅäÊ∞ó„Å´ÂÖ•„ÇäÔºà„É°„Ç§„É≥Ôºâ -->
            <button id="main-like-btn" class="like-btn mt-1 opacity-80 hover:opacity-100 transition" disabled>‚ô°</button>
        </div>

        <!-- „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº -->
        <div class="space-y-2 hide-on-minimal">
            <input type="range" id="progress-bar" min="0" max="100" value="0" class="w-full h-2 bg-transparent appearance-none cursor-pointer" disabled>
            <div class="flex justify-between text-xs font-mono">
                <span id="current-time-display" class="digital-time">0:00</span>
                <span id="duration-display" class="digital-time">0:00</span>
            </div>
            <!-- ‚úÖ A-BË°®Á§∫ -->
            <div id="ab-display" class="text-center text-xs opacity-80">A-B: OFF</div>
        </div>

        <!-- „Ç≥„É≥„Éà„É≠„Éº„É´Áæ§ -->
        <div class="space-y-4 hide-on-minimal">
            <div class="flex items-center justify-around"> 
                <button id="seek-backward-btn" class="control-btn transition-all transform hover:scale-110 active:scale-95 disabled:cursor-not-allowed" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8M3 12a9 9 0 1118 0 9 9 0 01-18 0z" />
                    </svg>
                </button>
                
                <button id="prev-btn" class="control-btn transition-all transform hover:scale-110 active:scale-95 disabled:cursor-not-allowed" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 20 20"><path d="M8.445 14.832A1 1 0 0010 14.226V5.774a1 1 0 00-1.555-.832L4 8.667V5a1 1 0 00-2 0v10a1 1 0 002 0v-3.667l4.445 3.5zM18 5v10a1 1 0 01-2 0V5a1 1 0 012 0z"/></svg>
                </button>
                
                <button id="play-pause-btn" class="w-16 h-16 rounded-full flex items-center justify-center shadow-lg transform hover:scale-105 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 ml-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 hidden" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1H8zm5 0a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1h-1z" clip-rule="evenodd" />
                    </svg>
                </button>

                <button id="next-btn" class="control-btn transition-all transform hover:scale-110 active:scale-95 disabled:cursor-not-allowed" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 20 20"><path d="M11.555 14.832A1 1 0 0110 14.226V5.774a1 1 0 011.555-.832l4.445 3.667V5a1 1 0 012 0v10a1 1 0 01-2 0v-3.667l-4.445 3.5zM2 5v10a1 1 0 002 0V5a1 1 0 00-2 0z"/></svg>
                </button>
                
                <button id="seek-forward-btn" class="control-btn transition-all transform hover:scale-110 active:scale-95 disabled:cursor-not-allowed" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 9l3 3m0 0l-3 3m3-3H5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            </div>

            <!-- „Çµ„Éñ„Ç≥„É≥„Éà„É≠„Éº„É´ -->
            <div class="flex items-center justify-center space-x-6 pt-2">
                <button id="shuffle-btn" class="control-btn transition-all transform hover:scale-110 active:scale-95 disabled:cursor-not-allowed" disabled>üîÄ</button>

                <button id="playback-rate-btn" class="control-btn transition-all transform hover:scale-110 active:scale-95 disabled:cursor-not-allowed text-sm font-bold w-10 h-10" disabled>
                    1x
                </button>

                <button id="repeat-btn" class="control-btn transition-all transform hover:scale-110 active:scale-95 disabled:cursor-not-allowed" disabled>üîÅ</button>

                <!-- ‚úÖ A-B„É™„Éî„Éº„Éà -->
                <button id="ab-toggle-btn" class="control-btn transition-all transform hover:scale-110 active:scale-95 disabled:cursor-not-allowed text-xs font-bold px-2 py-1 rounded" disabled>
                    A-B
                </button>

                <!-- ‚úÖ „Çπ„É™„Éº„Éó„Çø„Ç§„Éû„Éº -->
                <button id="sleep-btn" class="control-btn transition-all transform hover:scale-110 active:scale-95 disabled:cursor-not-allowed text-xs font-bold px-2 py-1 rounded" disabled>
                    Sleep: OFF
                </button>
            </div>
            
            <!-- Èü≥Èáè -->
            <div class="flex items-center space-x-2 pt-2">
                <button id="volume-mute-toggle" class="control-btn p-1">
                    <svg id="volume-high-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1V9a1 1 0 011-1h1.586l4.414-4.414A1 1 0 0112 4v16a1 1 0 01-2 0v-4.586l-4.414 4.414z" />
                    </svg>
                    <svg id="volume-mute-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5.586 15H4a1 1 0 01-1-1V9a1 1 0 011-1h1.586l4.414-4.414A1 1 0 0112 4v16a1 1 0 01-2 0v-4.586l-4.414 4.414zm9.646-1.55l-2.001-2.001M15.536 8.464L13.535 10.465" />
                    </svg>
                </button>
                <input type="range" id="volume-control" min="0" max="1" step="0.01" value="1" class="w-full h-2 bg-transparent appearance-none cursor-pointer">
            </div>
        </div>
    </div>
    
    <!-- „Éó„É¨„Ç§„É™„Çπ„Éà„Éë„Éç„É´ -->
    <div id="playlist-panel">
        <div class="flex justify-between items-center border-b pb-4 mb-4" style="border-color: rgba(255,255,255,0.3);">
            <h2 class="text-2xl font-bold">„Éó„É¨„Ç§„É™„Çπ„Éà</h2>
            <button id="playlist-close-btn" class="control-btn p-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <div class="mb-4">
            <input type="search" id="playlist-search" class="w-full p-2 rounded-lg border text-sm" placeholder="„Éó„É¨„Ç§„É™„Çπ„Éà„ÇíÊ§úÁ¥¢...">
        </div>

        <ul id="playlist-ul" class="space-y-3 overflow-y-auto" style="height: calc(100% - 8rem);">
            <li class="placeholder text-center pt-10">Êõ≤„Çí„Éâ„É≠„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>
        </ul>
    </div>

    <div id="toast"><span id="toast-message"></span></div>

    <script>
        const audioPlayer = document.getElementById('audio-player');
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const albumArt = document.getElementById('album-art');
        const progressBar = document.getElementById('progress-bar');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const currentTimeDisplay = document.getElementById('current-time-display');
        const durationDisplay = document.getElementById('duration-display');
        const songTitle = document.getElementById('song-title');
        const songArtist = document.getElementById('song-artist');
        const playerContainer = document.getElementById('player-container');
        const fileSelectUI = document.getElementById('file-select-ui'); 
        
        const minimalPlayBtnOverlay = document.getElementById('minimal-play-btn-overlay');
        const minimalPlayIcon = document.getElementById('minimal-play-icon');
        const minimalPauseIcon = document.getElementById('minimal-pause-icon');
        let isMinimalMode = false;
        
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const shuffleBtn = document.getElementById('shuffle-btn');
        const repeatBtn = document.getElementById('repeat-btn');
        const volumeControl = document.getElementById('volume-control');
        const volumeHighIcon = document.getElementById('volume-high-icon');
        const volumeMuteIcon = document.getElementById('volume-mute-icon');
        const volumeMuteToggle = document.getElementById('volume-mute-toggle');

        const seekForwardBtn = document.getElementById('seek-forward-btn');
        const seekBackwardBtn = document.getElementById('seek-backward-btn');
        const playlistToggleBtn = document.getElementById('playlist-toggle-btn');
        const playlistCloseBtn = document.getElementById('playlist-close-btn');
        const playlistPanel = document.getElementById('playlist-panel');
        const playlistUl = document.getElementById('playlist-ul');
        const playbackRateBtn = document.getElementById('playback-rate-btn');
        const playlistSearch = document.getElementById('playlist-search');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const mainLikeBtn = document.getElementById('main-like-btn');

        const abToggleBtn = document.getElementById('ab-toggle-btn');
        const abDisplay = document.getElementById('ab-display');
        const sleepBtn = document.getElementById('sleep-btn');

        const visualizerCanvas = document.getElementById('visualizer-canvas');
        const canvasCtx = visualizerCanvas.getContext('2d');
        let audioContext, analyser, source, frequencyData;
        const FFT_SIZE = 512; 
        let bufferLength;
        let isAudioContextInitialized = false;
        let visualizerStyle = 'line';

        let playlist = []; 
        let currentTrackIndex = -1;
        let isShuffle = false;
        let repeatMode = 'none'; 
        let shuffledPlaylist = [];
        const playbackRates = [1, 1.25, 1.5, 2, 0.75];
        let currentRateIndex = 0;
        let lastVolume = 1;
        let toastTimeout;

        // ‚úÖ LikeÔºàÊ∞∏Á∂öÔºâ
        const LIKES_KEY = "mp3PlayerLikes_v3";
        let likesMap = {};
        function loadLikes() {
            try {
                likesMap = JSON.parse(localStorage.getItem(LIKES_KEY) || "{}");
            } catch { likesMap = {}; }
        }
        function saveLikes() {
            localStorage.setItem(LIKES_KEY, JSON.stringify(likesMap));
        }
        function isLiked(track) {
            return !!likesMap[track.key];
        }
        function toggleLike(track) {
            likesMap[track.key] = !likesMap[track.key];
            saveLikes();
        }

        // ‚úÖ A-B„É´„Éº„Éó
        let abMode = 0; // 0=off, 1=A set, 2=AB active
        let abA = null, abB = null;

        // ‚úÖ „Çπ„É™„Éº„Éó
        const sleepOptions = [0, 15, 30, 60];
        let sleepIndex = 0;
        let sleepRemaining = 0;
        let sleepTimerInterval = null;

        const jsmediatags = window.jsmediatags;

        // --- „Ç§„Éô„É≥„Éà ---
        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) handleFiles(files);
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('bg-white/10', 'scale-105');
        });
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('bg-white/10', 'scale-105');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('bg-white/10', 'scale-105');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const mp3Files = Array.from(files).filter(file => file.type === 'audio/mpeg');
                if (mp3Files.length > 0) handleFiles(mp3Files);
                else showToast("MP3„Éï„Ç°„Ç§„É´„ÅÆ„ÅøÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åô", true);
            }
        });

        dropZone.addEventListener('dblclick', toggleMinimalMode);

        dropZone.addEventListener('click', (e) => {
            if (!isMinimalMode) return;
            e.stopPropagation();
            if (playlist.length === 0) return;
            if (!isAudioContextInitialized) { initAudioContext(); drawVisualizer(); }
            if (currentTrackIndex === -1) loadTrack(0);
            else togglePlayPause();
        });

        playPauseBtn.addEventListener('click', () => {
            if (!isAudioContextInitialized) { initAudioContext(); drawVisualizer(); }
            if (audioContext && audioContext.state === 'suspended') audioContext.resume();
            if (playlist.length === 0) return;
            if (currentTrackIndex === -1) { loadTrack(0); return; }
            togglePlayPause();
        });

        audioPlayer.addEventListener('play', () => {
            updatePlayPauseIcon();
            updateMinimalOverlay();
            highlightCurrentTrack();
        });
        audioPlayer.addEventListener('pause', () => {
            updatePlayPauseIcon();
            updateMinimalOverlay();
        });

        audioPlayer.addEventListener('ended', () => {
            if (repeatMode === 'one') {
                audioPlayer.currentTime = 0;
                audioPlayer.play();
            } else playNext();
        });

        audioPlayer.addEventListener('timeupdate', () => {
            updateProgress();
            // ‚úÖ A-B active
            if (abMode === 2 && abA != null && abB != null && audioPlayer.currentTime >= abB) {
                audioPlayer.currentTime = abA;
            }
        });
        audioPlayer.addEventListener('loadedmetadata', setDuration);

        progressBar.addEventListener('input', (e) => {
            if (!audioPlayer.duration) return;
            const newTime = audioPlayer.duration * (e.target.value / 100);
            currentTimeDisplay.textContent = formatTime(newTime);
        });
        progressBar.addEventListener('change', (e) => {
            if (!audioPlayer.duration) return;
            const newTime = audioPlayer.duration * (e.target.value / 100);
            audioPlayer.currentTime = newTime; 
        });

        volumeControl.addEventListener('input', (e) => {
            const volume = parseFloat(e.target.value);
            audioPlayer.volume = volume;
            if (volume > 0) lastVolume = volume;
            updateVolumeIcon(volume);
            saveSettings();
        });

        volumeMuteToggle.addEventListener('click', () => {
            if (audioPlayer.volume > 0) audioPlayer.volume = 0;
            else audioPlayer.volume = lastVolume;
            volumeControl.value = audioPlayer.volume;
            updateVolumeIcon(audioPlayer.volume);
            saveSettings();
        });

        prevBtn.addEventListener('click', playPrev);
        nextBtn.addEventListener('click', playNext);
        shuffleBtn.addEventListener('click', toggleShuffle);
        repeatBtn.addEventListener('click', toggleRepeat);
        seekForwardBtn.addEventListener('click', () => seek(10));
        seekBackwardBtn.addEventListener('click', () => seek(-10));

        playlistToggleBtn.addEventListener('click', togglePlaylist);
        playlistCloseBtn.addEventListener('click', togglePlaylist);

        playbackRateBtn.addEventListener('click', changePlaybackRate);
        playlistSearch.addEventListener('input', filterPlaylist);

        // ‚úÖ LikeÔºà„É°„Ç§„É≥Ôºâ
        mainLikeBtn.addEventListener('click', () => {
            if (currentTrackIndex < 0) return;
            const track = playlist[currentTrackIndex];
            toggleLike(track);
            updateLikeUI();
            renderPlaylist();
        });

        // ‚úÖ A-B„Éú„Çø„É≥
        abToggleBtn.addEventListener('click', () => {
            if (currentTrackIndex < 0) return;
            if (abMode === 0) {
                abA = audioPlayer.currentTime;
                abB = null;
                abMode = 1;
                showToast(`A „ÇíË®≠ÂÆö: ${formatTime(abA)}`);
            } else if (abMode === 1) {
                const t = audioPlayer.currentTime;
                if (t <= abA + 1) {
                    showToast("B „ÅØA„Çà„Çä1Áßí‰ª•‰∏äÂæå„Å´„Åó„Å¶„Å≠", true);
                    return;
                }
                abB = t;
                abMode = 2;
                showToast(`B „ÇíË®≠ÂÆö: ${formatTime(abB)}ÔºàA-B„É´„Éº„ÉóONÔºâ`);
            } else {
                abMode = 0;
                abA = abB = null;
                showToast("A-B„É´„Éº„ÉóËß£Èô§");
            }
            updateABDisplay();
            saveSettings();
        });

        // ‚úÖ Sleep„Éú„Çø„É≥
        sleepBtn.addEventListener('click', () => {
            sleepIndex = (sleepIndex + 1) % sleepOptions.length;
            const mins = sleepOptions[sleepIndex];
            if (mins === 0) {
                stopSleepTimer();
                showToast("„Çπ„É™„Éº„Éó: OFF");
            } else {
                startSleepTimer(mins);
                showToast(`„Çπ„É™„Éº„Éó: ${mins}ÂàÜ`);
            }
            updateSleepBtn();
            saveSettings();
        });

        document.addEventListener('keydown', (e) => {
            if (e.target === playlistSearch) return;
            if (playlist.length === 0) return;

            if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                playPauseBtn.click();
            }
            if (e.code === 'ArrowRight') {
                e.preventDefault();
                if (e.shiftKey) playNext();
                else seek(10);
            }
            if (e.code === 'ArrowLeft') {
                e.preventDefault();
                if (e.shiftKey) playPrev();
                else seek(-10);
            }
            // ‚úÖ M„Åß„Éü„É•„Éº„Éà
            if (e.code === 'KeyM') volumeMuteToggle.click();
        });

        // --- Èñ¢Êï∞ ---
        function showToast(message, isError = false) {
            if (toastTimeout) clearTimeout(toastTimeout);
            toastMessage.textContent = message;
            toast.style.backgroundColor = isError ? 'var(--thumb-color)' : 'var(--toast-bg)';
            toast.classList.add('show');
            toastTimeout = setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function filterPlaylist(e) {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('#playlist-ul li.playlist-item').forEach(li => {
                const index = parseInt(li.dataset.index);
                const track = playlist[index];
                if (!track) return;
                const isMatch = track.title.toLowerCase().includes(query) || track.artist.toLowerCase().includes(query);
                li.classList.toggle('hidden', !isMatch);
            });
        }

        function changePlaybackRate() {
            currentRateIndex = (currentRateIndex + 1) % playbackRates.length;
            const newRate = playbackRates[currentRateIndex];
            audioPlayer.playbackRate = newRate;
            playbackRateBtn.textContent = `${newRate}x`;
            saveSettings();
        }

        function seek(time) {
            if (audioPlayer.readyState >= 2) {
                audioPlayer.currentTime = Math.min(Math.max(0, audioPlayer.currentTime + time), audioPlayer.duration);
            }
        }

        function togglePlaylist() {
            playlistPanel.classList.toggle('open');
        }

        function initAudioContext() {
            if (isAudioContextInitialized) return;
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            source = audioContext.createMediaElementSource(audioPlayer);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = FFT_SIZE;
            analyser.smoothingTimeConstant = 0.85;
            bufferLength = analyser.frequencyBinCount;
            frequencyData = new Uint8Array(bufferLength);
            source.connect(analyser);
            analyser.connect(audioContext.destination);
            setupCanvas();
            isAudioContextInitialized = true;
        }

        function setupCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const { offsetWidth, offsetHeight } = visualizerCanvas.parentElement;
            visualizerCanvas.width = offsetWidth * dpr;
            visualizerCanvas.height = offsetHeight * dpr;
            canvasCtx.setTransform(1, 0, 0, 1, 0, 0);
            canvasCtx.scale(dpr, dpr);
        }

        window.addEventListener('resize', () => {
            if (isAudioContextInitialized) setupCanvas();
        });

        function drawVisualizer() {
            requestAnimationFrame(drawVisualizer);
            if (!isAudioContextInitialized || audioPlayer.paused) {
                const { offsetWidth, offsetHeight } = visualizerCanvas.parentElement;
                canvasCtx.clearRect(0, 0, offsetWidth, offsetHeight);
                return;
            }
            analyser.getByteFrequencyData(frequencyData);
            const { width, height } = visualizerCanvas.getBoundingClientRect();
            canvasCtx.clearRect(0, 0, width, height);

            const styles = getComputedStyle(document.documentElement);
            const gradColor1 = styles.getPropertyValue('--viz-grad-1').trim();
            const gradColor2 = styles.getPropertyValue('--viz-grad-2').trim();
            const gradColor3 = styles.getPropertyValue('--viz-grad-3').trim();

            const gradHeight = height * 0.40;
            const gradient = canvasCtx.createLinearGradient(0, gradHeight, 0, 0);
            gradient.addColorStop(0, gradColor1);
            gradient.addColorStop(0.5, gradColor2);
            gradient.addColorStop(1, gradColor3);

            canvasCtx.fillStyle = gradient;
            canvasCtx.strokeStyle = gradient;
            canvasCtx.lineCap = 'round';
            drawVizLine(width, height, gradHeight);
        }

        function drawVizLine(width, height, gradHeight) {
            canvasCtx.lineWidth = 3;
            const activeBufferLength = Math.floor(bufferLength / 2);
            const sliceWidth = (width / 2) / activeBufferLength;
            canvasCtx.beginPath();

            for (let i = activeBufferLength - 1; i >= 0; i--) {
                const normalizedValue = frequencyData[i] / 255;
                const barHeight = Math.pow(normalizedValue, 1.5) * gradHeight * 0.9;
                const x = (width / 2) - ((activeBufferLength - i) * sliceWidth);
                canvasCtx.lineTo(x, height - barHeight);
            }
            for (let i = 0; i < activeBufferLength; i++) {
                const normalizedValue = frequencyData[i] / 255;
                const barHeight = Math.pow(normalizedValue, 1.5) * gradHeight * 0.9;
                const x = (width / 2) + (i * sliceWidth);
                canvasCtx.lineTo(x, height - barHeight);
            }
            canvasCtx.stroke();
        }

        function handleFiles(files) {
            const newFiles = Array.from(files).filter(file => file.type === 'audio/mpeg');
            const wasEmpty = playlist.length === 0;

            for (const file of newFiles) {
                const key = `${file.name}_${file.size}_${file.lastModified}`; // ‚úÖ ÂÆâÂÆö„Ç≠„Éº
                playlist.push({
                    key,
                    file,
                    title: file.name,
                    artist: '„É≠„Éº„Éâ‰∏≠...',
                    artwork: null,
                    duration: null
                });
                const newIndex = playlist.length - 1;
                readMetadataAndRender(file, newIndex);
                getTrackDuration(file, newIndex);
            }

            showToast(`${newFiles.length} Êõ≤„ÅåËøΩÂä†„Åï„Çå„Åæ„Åó„Åü`);

            enableControls();
            updateFileUIState();

            if (wasEmpty && playlist.length > 0) prepareTrack(0);
            if (isShuffle) createShuffledPlaylist();
            renderPlaylist();
        }

        function readMetadataAndRender(file, index) {
            jsmediatags.read(file, {
                onSuccess: (tag) => {
                    const tags = tag.tags;
                    let artworkUrl = null;
                    if (tags.picture) {
                        const { data, format } = tags.picture;
                        let base64String = "";
                        for (let i = 0; i < data.length; i++) base64String += String.fromCharCode(data[i]);
                        artworkUrl = `data:${format};base64,${window.btoa(base64String)}`;
                    }

                    playlist[index].title = tags.title || file.name;
                    playlist[index].artist = tags.artist || '‰∏çÊòé„Å™„Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà';
                    playlist[index].artwork = artworkUrl;

                    if (index === currentTrackIndex) updateMainUI(index);
                    renderPlaylist();
                },
                onError: () => {
                    playlist[index].artist = '„É°„Çø„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                    renderPlaylist();
                }
            });
        }

        function getTrackDuration(file, index) {
            const tempAudio = new Audio();
            const url = URL.createObjectURL(file);
            tempAudio.src = url;
            tempAudio.addEventListener('loadedmetadata', () => {
                if (playlist[index]) playlist[index].duration = tempAudio.duration;
                renderPlaylist();
                URL.revokeObjectURL(url);
            });
            tempAudio.addEventListener('error', () => URL.revokeObjectURL(url));
        }

        function updateMainUI(index) {
            if (index < 0 || !playlist[index]) {
                songTitle.textContent = 'ÂÜçÁîü„Åô„ÇãÊõ≤„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì';
                songArtist.textContent = '„Éï„Ç°„Ç§„É´„Çí„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                mainLikeBtn.disabled = true;
                return;
            }
            const track = playlist[index];
            songTitle.textContent = track.title;
            songArtist.textContent = track.artist;

            if (track.artwork) { albumArt.src = track.artwork; albumArt.classList.remove('opacity-20'); }
            else resetAlbumArt();

            mainLikeBtn.disabled = false;
            updateLikeUI();
        }

        function prepareTrack(index) {
            if (index < 0 || index >= playlist.length) return;
            currentTrackIndex = index;
            const track = playlist[index];
            const fileURL = URL.createObjectURL(track.file);
            audioPlayer.src = fileURL;
            audioPlayer.playbackRate = playbackRates[currentRateIndex];
            updateMainUI(index);
            updateNavButtons();
            highlightCurrentTrack();
        }

        function loadTrack(index) {
            if (index < 0 || index >= playlist.length) return;
            if (!isAudioContextInitialized) { initAudioContext(); drawVisualizer(); }
            if (audioContext && audioContext.state === 'suspended') audioContext.resume();
            prepareTrack(index);
            audioPlayer.play().catch(() => { audioPlayer.pause(); updatePlayPauseIcon(); });
        }

        function resetAlbumArt() {
            albumArt.src = 'https://placehold.co/512x512/312e81/ffffff?text=MP3';
            albumArt.classList.add('opacity-20');
        }

        function togglePlayPause() {
            if (audioPlayer.paused) audioPlayer.play();
            else audioPlayer.pause();
        }

        function updatePlayPauseIcon() {
            const isPaused = audioPlayer.paused || audioPlayer.ended;
            playIcon.classList.toggle('hidden', !isPaused);
            pauseIcon.classList.toggle('hidden', isPaused);
            minimalPlayIcon.classList.toggle('hidden', !isPaused);
            minimalPauseIcon.classList.toggle('hidden', isPaused);
        }

        function updateMinimalOverlay() {
            if (!isMinimalMode) {
                minimalPlayBtnOverlay.classList.add('opacity-0', 'pointer-events-none');
                return;
            }
            if (audioPlayer.paused || audioPlayer.ended) {
                minimalPlayBtnOverlay.classList.remove('opacity-0', 'pointer-events-none');
                minimalPlayBtnOverlay.classList.add('pointer-events-auto');
            } else {
                minimalPlayBtnOverlay.classList.add('opacity-0', 'pointer-events-none');
                minimalPlayBtnOverlay.classList.remove('pointer-events-auto');
            }
        }

        function updateProgress() {
            if (!audioPlayer.duration) return;
            const percentage = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressBar.value = percentage;
            currentTimeDisplay.textContent = formatTime(audioPlayer.currentTime);
        }

        function setDuration() {
            if (audioPlayer.duration) durationDisplay.textContent = formatTime(audioPlayer.duration);
        }

        function formatTime(seconds) {
            if (isNaN(seconds) || seconds == null) return '--:--';
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function enableControls() {
            const isDisabled = playlist.length === 0;
            playPauseBtn.disabled = isDisabled;
            progressBar.disabled = isDisabled;
            prevBtn.disabled = isDisabled;
            nextBtn.disabled = isDisabled;
            shuffleBtn.disabled = isDisabled;
            repeatBtn.disabled = isDisabled;
            seekForwardBtn.disabled = isDisabled;
            seekBackwardBtn.disabled = isDisabled;
            playlistToggleBtn.disabled = isDisabled;
            playbackRateBtn.disabled = isDisabled;
            abToggleBtn.disabled = isDisabled;
            sleepBtn.disabled = isDisabled;
            mainLikeBtn.disabled = isDisabled;
        }

        function updateFileUIState() {
            if (playlist.length > 0) fileSelectUI.classList.add('file-select-hidden');
            else fileSelectUI.classList.remove('file-select-hidden');
        }

        function updateNavButtons() {
            if (playlist.length <= 1) { prevBtn.disabled = true; nextBtn.disabled = true; return; }
            prevBtn.disabled = false; nextBtn.disabled = false;
        }

        function playNext() {
            if (playlist.length === 0) return;
            let newIndex = (currentTrackIndex + 1) % playlist.length;
            if (!isShuffle && repeatMode === 'none' && currentTrackIndex === playlist.length - 1) {
                audioPlayer.pause(); currentTrackIndex = -1; prepareTrack(0); return;
            }
            loadTrack(newIndex);
        }

        function playPrev() {
            if (playlist.length === 0) return;
            if (audioPlayer.currentTime > 5) { audioPlayer.currentTime = 0; return; }
            let newIndex = Math.max(0, currentTrackIndex - 1);
            loadTrack(newIndex);
        }

        function toggleShuffle() {
            isShuffle = !isShuffle;
            shuffleBtn.classList.toggle('btn-active', isShuffle);
            if (isShuffle) createShuffledPlaylist();
            saveSettings();
        }

        function createShuffledPlaylist() {
            let remaining = playlist.map((_, i) => i);
            for (let i = remaining.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [remaining[i], remaining[j]] = [remaining[j], remaining[i]];
            }
            shuffledPlaylist = remaining;
        }

        function toggleRepeat() {
            if (repeatMode === 'none') repeatMode = 'all';
            else if (repeatMode === 'all') repeatMode = 'one';
            else repeatMode = 'none';
            repeatBtn.classList.toggle('btn-active', repeatMode !== 'none');
            saveSettings();
        }

        function updateVolumeIcon(volume) {
            if (volume === 0) { volumeHighIcon.classList.add('hidden'); volumeMuteIcon.classList.remove('hidden'); }
            else { volumeHighIcon.classList.remove('hidden'); volumeMuteIcon.classList.add('hidden'); }
        }

        function toggleMinimalMode() {
            if (playlist.length === 0) return;
            isMinimalMode = !isMinimalMode;
            playerContainer.classList.toggle('minimal', isMinimalMode);
            updateMinimalOverlay();
        }

        // ‚úÖ Like UI
        function updateLikeUI() {
            const track = playlist[currentTrackIndex];
            const liked = track && isLiked(track);
            mainLikeBtn.textContent = liked ? "‚ô•" : "‚ô°";
            mainLikeBtn.classList.toggle("active", liked);
        }

        // ‚úÖ A-BË°®Á§∫
        function updateABDisplay() {
            if (abMode === 0) abDisplay.textContent = "A-B: OFF";
            if (abMode === 1) abDisplay.textContent = `A: ${formatTime(abA)} / B: --:--`;
            if (abMode === 2) abDisplay.textContent = `A: ${formatTime(abA)} / B: ${formatTime(abB)} (LOOP)`;
        }

        // ‚úÖ Sleep UI
        function updateSleepBtn() {
            const mins = sleepOptions[sleepIndex];
            sleepBtn.textContent = mins === 0 ? "Sleep: OFF" : `Sleep: ${mins}m`;
        }

        function startSleepTimer(mins) {
            stopSleepTimer();
            sleepRemaining = mins * 60;
            sleepTimerInterval = setInterval(() => {
                sleepRemaining--;
                if (sleepRemaining <= 0) {
                    stopSleepTimer();
                    fadeOutAndPause();
                }
            }, 1000);
        }

        function stopSleepTimer() {
            if (sleepTimerInterval) clearInterval(sleepTimerInterval);
            sleepTimerInterval = null;
            sleepRemaining = 0;
        }

        function fadeOutAndPause() {
            const original = audioPlayer.volume;
            const steps = 20;
            let i = 0;
            const iv = setInterval(() => {
                i++;
                audioPlayer.volume = Math.max(0, original * (1 - i/steps));
                volumeControl.value = audioPlayer.volume;
                if (i >= steps) {
                    clearInterval(iv);
                    audioPlayer.pause();
                    audioPlayer.volume = original;
                    volumeControl.value = original;
                    updateVolumeIcon(original);
                    showToast("„Çπ„É™„Éº„ÉóÂÅúÊ≠¢„Åó„Åæ„Åó„Åü");
                }
            }, 100);
        }

        // ‚úÖ „Éó„É¨„Ç§„É™„Çπ„ÉàÊèèÁîª + DnD‰∏¶„ÅπÊõø„Åà
        let dragSrcIndex = null;

        function renderPlaylist() {
            playlistUl.innerHTML = '';
            if (playlist.length === 0) {
                playlistUl.innerHTML = '<li class="placeholder text-center pt-10">Êõ≤„Çí„Éâ„É≠„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ</li>';
                updateMainUI(-1);
                return;
            }

            playlist.forEach((track, index) => {
                const li = document.createElement('li');
                li.className = 'playlist-item flex items-center space-x-3 p-2 rounded-lg cursor-pointer transition-colors relative group';
                li.dataset.index = index;
                li.id = `track-${index}`;
                li.draggable = true;

                // drag
                li.addEventListener('dragstart', (e) => {
                    dragSrcIndex = index;
                    li.classList.add('dragging');
                    e.dataTransfer.effectAllowed = "move";
                });
                li.addEventListener('dragend', () => li.classList.remove('dragging'));
                li.addEventListener('dragover', (e) => e.preventDefault());
                li.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const dstIndex = parseInt(li.dataset.index);
                    if (dragSrcIndex == null || dstIndex === dragSrcIndex) return;

                    const moved = playlist.splice(dragSrcIndex, 1)[0];
                    playlist.splice(dstIndex, 0, moved);

                    // current index ÂÜçË®àÁÆó
                    if (currentTrackIndex === dragSrcIndex) currentTrackIndex = dstIndex;
                    else if (dragSrcIndex < currentTrackIndex && dstIndex >= currentTrackIndex) currentTrackIndex--;
                    else if (dragSrcIndex > currentTrackIndex && dstIndex <= currentTrackIndex) currentTrackIndex++;

                    if (isShuffle) createShuffledPlaylist();
                    renderPlaylist();
                    highlightCurrentTrack();
                    saveSettings();
                });

                const img = document.createElement('img');
                img.src = track.artwork || 'https://placehold.co/50x50/312e81/ffffff?text=MP3';
                img.className = 'w-10 h-10 object-cover rounded-md';
                li.appendChild(img);

                const infoDiv = document.createElement('div');
                infoDiv.className = 'flex-grow min-w-0';
                if (track.artist === '„É≠„Éº„Éâ‰∏≠...') {
                    infoDiv.innerHTML = `
                        <p class="text-sm font-medium truncate">${track.title}</p>
                        <p class="text-xs truncate w-24 h-4 rounded bg-gray-500/30 animate-pulse"></p>
                    `;
                } else {
                    infoDiv.innerHTML = `
                        <p class="text-sm font-medium truncate">${track.title}</p>
                        <p class="text-xs truncate" style="color: var(--text-secondary);">${track.artist}</p>
                    `;
                }
                li.appendChild(infoDiv);

                const durationSpan = document.createElement('span');
                durationSpan.className = 'text-xs font-mono px-2 playlist-duration';
                durationSpan.textContent = formatTime(track.duration);
                if (track.duration === null) durationSpan.className += ' w-8 h-4 rounded bg-gray-500/30 animate-pulse';
                li.appendChild(durationSpan);

                // ‚úÖ LikeÔºà„Éó„É¨„Ç§„É™„Çπ„ÉàÔºâ
                const likeBtn = document.createElement("button");
                likeBtn.className = "like-btn px-1 opacity-0 group-hover:opacity-100 transition";
                const liked = isLiked(track);
                likeBtn.textContent = liked ? "‚ô•" : "‚ô°";
                likeBtn.classList.toggle("active", liked);
                likeBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    toggleLike(track);
                    renderPlaylist();
                    if (index === currentTrackIndex) updateLikeUI();
                });
                li.appendChild(likeBtn);

                li.addEventListener('click', () => loadTrack(index));
                playlistUl.appendChild(li);
            });

            highlightCurrentTrack();
        }

        function highlightCurrentTrack() {
            document.querySelectorAll('#playlist-ul li').forEach(li => li.classList.remove('active'));
            const currentLi = document.getElementById(`track-${currentTrackIndex}`);
            if (currentLi) currentLi.classList.add('active');
        }

        // --- Ë®≠ÂÆö‰øùÂ≠ò ---
        const SETTINGS_KEY = 'mp3PlayerSettings_v3';

        function saveSettings() {
            const settings = {
                volume: audioPlayer.volume,
                lastVolume,
                repeatMode,
                isShuffle,
                playbackRateIndex: currentRateIndex,
                sleepIndex,
                abMode,
                abA,
                abB
            };
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        }

        function loadSettings() {
            try {
                const saved = JSON.parse(localStorage.getItem(SETTINGS_KEY) || "null");
                if (!saved) return;

                audioPlayer.volume = saved.volume ?? 1;
                volumeControl.value = audioPlayer.volume;
                lastVolume = saved.lastVolume ?? audioPlayer.volume;
                updateVolumeIcon(audioPlayer.volume);

                repeatMode = saved.repeatMode || "none";
                isShuffle = !!saved.isShuffle;
                shuffleBtn.classList.toggle("btn-active", isShuffle);

                currentRateIndex = saved.playbackRateIndex ?? 0;
                audioPlayer.playbackRate = playbackRates[currentRateIndex];
                playbackRateBtn.textContent = `${playbackRates[currentRateIndex]}x`;

                sleepIndex = saved.sleepIndex ?? 0;
                updateSleepBtn();

                abMode = saved.abMode ?? 0;
                abA = saved.abA ?? null;
                abB = saved.abB ?? null;
                updateABDisplay();
            } catch {}
        }

        // --- ÂàùÊúüÂåñ ---
        loadLikes();
        loadSettings();
        renderPlaylist();
        updateFileUIState();
        enableControls();
        updateABDisplay();
        updateSleepBtn();
    </script>
</body>
</html>
